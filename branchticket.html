<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branch Resolved Tickets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div class="container mx-auto p-4">
        <div class="flex justify-start border-b border-gray-300 mb-4">
            <button id="openTicketsTab" class="px-4 py-2 text-blue-500" onclick="showOpenTickets()">Branch Open Tickets (0)</button>
            <button id="resolvedTicketsTab" class="px-4 py-2 text-blue-500 border-b-2 border-blue-500" onclick="showResolvedTickets()">Branch Resolved Tickets (0)</button>
        </div>
        <div class="flex justify-center mb-4">
            <input type="text" id="searchInput" placeholder="Search by Clientcode / Ticket No" class="w-full p-2 border border-gray-300 rounded" oninput="filterTickets()">
        </div>
        <div id="ticketContainer" class="space-y-4">
            <!-- Tickets will be dynamically generated here -->
        </div>
    </div>

    <script>
        let ticketData = {
            "branches": []
        };

        let currentTab = 'resolved'; // Default to resolved tickets

        async function fetchResolvedTickets() {
            const branchCode = 'HOSUR'; // You can replace this with dynamic data from router params
            const createdBy = 'BRANCH'; // You can replace this with dynamic data from router params
            const apiUrl = `https://g1.gwcindia.in/ticket-api/resolved-tickets.php?branchCode=${branchCode}&createdBy=${createdBy}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.status === "ok") {
                    ticketData.branches = data.tickets.map(ticket => ({
                        name: ticket.clientCode,
                        tickets: [{
                            number: `#${ticket.ticketNo}`,
                            status: ticket.ticketStatus_id === "2" ? "CLOSED" : "OPEN"
                        }]
                    }));
                    updateTicketDisplay();
                    document.getElementById('resolvedTicketsTab').innerText = `Branch Resolved Tickets (${data.tickets.length})`;
                } else {
                    console.error("Failed to fetch tickets:", data);
                }
            } catch (error) {
                console.error("Error fetching tickets:", error);
            }
        }

        async function fetchOpenTickets() {
            const branchCode = 'HOSUR'; // You can replace this with dynamic data from router params
            const createdBy = 'BRANCH'; // You can replace this with dynamic data from router params
            const apiUrl = `https://g1.gwcindia.in/ticket-api/open-tickets.php?branchCode=${branchCode}&createdBy=${createdBy}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.status === "ok") {
                    ticketData.branches = data.tickets.map(ticket => ({
                        name: ticket.clientCode,
                        tickets: [{
                            number: `#${ticket.ticketNo}`,
                            status: ticket.ticketStatus_id === "1" ? "OPEN" : "CLOSED" // Assuming status_id "1" means OPEN
                        }]
                    }));
                    updateTicketDisplay();
                    document.getElementById('openTicketsTab').innerText = `Branch Open Tickets (${data.tickets.length})`;
                } else {
                    console.error("Failed to fetch tickets:", data);
                }
            } catch (error) {
                console.error("Error fetching tickets:", error);
            }
        }

        function showOpenTickets() {
            currentTab = 'open';
            fetchOpenTickets(); // Fetch open tickets when the tab is clicked
            document.getElementById('openTicketsTab').classList.add('border-b-2', 'border-blue-500');
            document.getElementById('resolvedTicketsTab').classList.remove('border-b- 2', 'border-blue-500');
        }

        function showResolvedTickets() {
            currentTab = 'resolved';
            fetchResolvedTickets(); // Fetch resolved tickets when the tab is clicked
            document.getElementById('resolvedTicketsTab').classList.add('border-b-2', 'border-blue-500');
            document.getElementById('openTicketsTab').classList.remove('border-b-2', 'border-blue-500');
        }

        function updateTicketDisplay() {
            const ticketContainer = document.getElementById('ticketContainer');
            ticketContainer.innerHTML = ''; // Clear previous tickets

            ticketData.branches.forEach(branch => {
                const branchDiv = document.createElement('div');
                branchDiv.className = 'bg-white p-4 rounded shadow cursor-pointer';
                branchDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="font-bold">${branch.name}</span>
                        <i class="fas fa-chevron-down cursor-pointer" onclick="toggleTickets('${branch.name}')"></i>
                    </div>
                    <div id="${branch.name}-tickets" class="hidden mt-2 space-y-2">
                    </div> 
                `;
                ticketContainer.appendChild(branchDiv);

                // Populate tickets based on the current tab
                branch.tickets.forEach(ticket => {
                    const ticketDiv = document.createElement('div');
                    ticketDiv.className = 'flex justify-between items-center p-2 bg-gray-100 rounded cursor-pointer';
                    ticketDiv.innerHTML = `
                        <span>${ticket.number}</span>
                        <span class="${ticket.status === 'CLOSED' ? 'text-green-500' : 'text-red-500'}">${ticket.status}</span>
                    `;
                    ticketDiv.onclick = () => {
                        window.location.href = `http://127.0.0.1:5500/branchticketdetails.html?ticketNo=${ticket.number}&clientCode=${branch.name}`;
                    };
                    document.getElementById(`${branch.name}-tickets`).appendChild(ticketDiv);
                });
            });
        }

        function filterTickets() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const ticketContainer = document.getElementById('ticketContainer');
            const branches = ticketData.branches;

            ticketContainer.innerHTML = ''; // Clear previous tickets

            branches.forEach(branch => {
                const filteredTickets = branch.tickets.filter(ticket => 
                    ticket.number.toLowerCase().includes(searchValue) || 
                    branch.name.toLowerCase().includes(searchValue)
                );

                if (filteredTickets.length > 0) {
                    const branchDiv = document.createElement('div');
                    branchDiv.className = 'bg-white p-4 rounded shadow cursor-pointer';
                    branchDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-bold">${branch.name}</span>
                            <i class="fas fa-chevron-down cursor-pointer" onclick="toggleTickets('${branch.name}')"></i>
                        </div>
                        <div id="${branch.name}-tickets" class="hidden mt-2 space-y-2">
                        </div>
                    `;
                    ticketContainer.appendChild(branchDiv);

                    filteredTickets.forEach(ticket => {
                        const ticketDiv = document.createElement('div');
                        ticketDiv.className = 'flex justify-between items-center p-2 bg-gray-100 rounded cursor-pointer';
                        ticketDiv.innerHTML = `
                            <span>${ticket.number}</span>
                            <span class="${ticket.status === 'CLOSED' ? 'text-green-500' : 'text-red-500'}">${ticket.status}</span>
                        `;
                        ticketDiv.onclick = () => {
                            window.location.href = `C:\\Users\\W3Dev\\Desktop\\funds\\branchticketdetails.html?ticketNo=${ticket.number}&clientCode=${branch.name}`;
                        };
                        document.getElementById(`${branch.name}-tickets`).appendChild(ticketDiv);
                    });
                }
            });
        }

        function toggleTickets(branchName) {
            const ticketsDiv = document.getElementById(`${branchName}-tickets`);
            ticketsDiv.classList.toggle('hidden');
        }

        // Fetch resolved tickets on page load
        window.onload = fetchResolvedTickets;
    </script>
</body>
</html>