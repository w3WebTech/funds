<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Raise a Ticket</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <style>
        .animated {
            -webkit-animation-duration: 1s;
            animation-duration: 1s;
            -webkit-animation-fill-mode: both;
            animation-fill-mode: both;
        }

        .fadeIn {
            -webkit-animation-name: fadeIn;
            animation-name: fadeIn;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Loader styles */
        .three-body {
            --uib-size: 35px;
            --uib-speed: 0.8s;
            --uib-color: #2741b6;
            position: relative;
            display: inline-block;
            height: var(--uib-size);
            width: var(--uib-size);
            animation: spin78236 calc(var(--uib-speed) * 2.5) infinite linear;
        }

        .three-body__dot {
            position: absolute;
            height: 100%;
            width: 30%;
        }

        @keyframes spin78236 {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="main-modal fixed w-full h-100 inset-0 z-50 overflow-hidden flex justify-center items-center animated fadeIn faster" style="background: rgba(0, 0, 0, 0.7)">
            <div class="border shadow-lg modal-container bg-white md:w-[90%] md:mx-auto rounded-xl shadow-lg z-50 overflow-y-auto">
                <div class="modal-content text-left h-full">
                    <div class="grid grid-cols-6 items-center p-3">
                        <div class="flex justify-center col-span-5">
                            <h3 class="font-bold text-gray-800">Raise a Ticket</h3>
                        </div>
                        <div class="col-span-1 flex justify-end">
                            <button type="button" class="flex justify-center items-center size-7 text-sm font-semibold rounded-full text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none" onclick="closeModal()">
                                <span class="sr-only">Close</span>
                                <svg class="flex-shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 6 6 18"></path>
                                    <path d="m6 6 12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="p-4 overflow-y-auto">
                        <div class="space-y-4">
                            <div class="w-full">
                                <button id="categoryButton" type="button" class="w-full py-3 px-4 inline-flex justify-between items-center gap-x-2 text-sm rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50" onclick="toggleCategoryDropdown()">
                                    <p id="selectedCategoryText">Select category</p>
                                    <svg class="hs-dropdown-open:rotate-180 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="m6 9 6 6 6-6" />
                                    </svg>
                                </button>
                                <div id="categoryDropdown" class="hidden relative">
                                    <div class="rounded-lg border absolute bg-gray-50 shadow-md z-50 w-full max-h-40 overflow-y-auto">
                                        <div id="categoryList"></div>
                                    </div>
                                </div>

                            </div>
                            <div class="w-full">
                                <button id="subcategoryButton" type="button" class="w-full py-3 px-4 inline-flex justify-between items-center gap-x-2 text-sm rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50" onclick="toggleSubcategoryDropdown()">
                                    <p id="selectedSubCategoryText">Select subcategory</p>
                                    <svg class="hs-dropdown-open:rotate-180 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="m6 9 6 6 6-6" />
                                    </svg>
                                </button>
                                <div id="subcategoryDropdown" class="hidden relative">
                                    <div class="rounded-lg border absolute bg-gray-50 shadow-md z-50 w-full max-h-40 overflow-y-auto">
                                        <div id="subcategoryList"></div>
                                    </div>
                                </div>
                            </div>
                            <input id="subjectInput" type="text" class="py-3 shadow-sm px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Subject" />
                            <textarea id="descriptionInput" class="py-3 shadow-sm px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Description"></textarea>
                            <div class="flex items-center justify-center w-full">
                                <label>
                                    <div class="flex gap-1 flex-row items-center justify-center cursor-pointer">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="blue" class="w-5 h-5">
                                            <path fill-rule="evenodd" d="M15.621 4.379a3 3 0 0 0-4.242 0l-7 7a3 3 0 0 0 4.241 4.243h.001l.497-.5a.75.75 0 0 1 1.064 1.057l-.498.501-.002.002a4.5 4.5 0 0 1-6.364-6.364l7-7a4.5 4.5 0 0 1 6.368 6.36l-3.455 3.553A2.625 2.625 0 1 1 9.52 9.52l3.45-3.451a.75.75 0 1 1 1.061 1.06l-3.45 3.451a1.125 1.125 0 0 0 1.587 1.595l3.454-3.553a3 3 0 0 0 0-4.242Z" clip-rule="evenodd" />
                                        </svg>
                                        <div class="text-xs text-[#2741b6] flex items-center justify-center">Attach Image or Pdf ( Max Size 5mb )</div>
                                    </div>
                                    <input id="fileInput" type="file" class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" onchange="uploadImage(event)" />
                                </label>
                            </div>
                            <div class="flex justify-end items-center gap-x-2 p-3">
                                <button id="createTicketButton" type="button" class="w-full py-3 px-4 inline-flex justify-center items-center gap-x-2 text-sm font-semibold rounded-lg bg-blue-700 text-white hover:bg-[#2741b6]" onclick="createTicket()">
                                    Create Ticket
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="responseModal" class="hidden main-modal fixed w-full h-100 inset-0 z-50 overflow-hidden flex justify-center items-center animated fadeIn faster" style="background: rgba(0, 0, 0, 0.7)">
            <div class="border shadow-lg modal-container bg-white w-11/12 mx-auto rounded-xl shadow-lg z-50 overflow-y-auto">
                <div class="modal-content py-4 text-left h-full">
                    
                    <div id="responseContent" class="flex justify-center p-2"></div>
                    <div class="flex justify-center items-center gap-x-2 py-3 px-4">
                        <button type="button" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700" onclick="closeResponseModal()">
                            Go Back
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let allCategories = [];
        let subcategories = [];
        let selectedCategory = null;
        let selectedSubCategory = null;
        let attachment = null;
        let selectedFileName = null;

        document.addEventListener('DOMContentLoaded', () => {
            getDepartmentData();
        });

        function toggleCategoryDropdown() {
            const dropdown = document.getElementById('categoryDropdown');
            dropdown.classList.toggle('hidden');
        }

        function toggleSubcategoryDropdown() {
            const dropdown = document.getElementById('subcategoryDropdown');
            dropdown.classList.toggle('hidden');
        }

        function selectCategory(category) {
            selectedCategory = category;
            document.getElementById('selectedCategoryText').innerText = category;
            document.getElementById('categoryDropdown').classList.add('hidden');
            getSubcategories(category);
        }

        function selectSubCategory(subCategory) {
            selectedSubCategory = subCategory;
            document.getElementById('selectedSubCategoryText').innerText = subCategory;
            document.getElementById('subcategoryDropdown').classList.add('hidden');
        }

        async function getDepartmentData() {
            try {
                const response = await axios.get('https://g1.gwcindia.in/ticket-api/ticket-category-subcategory.php');
                allCategories = response.data.map(item => Object.keys(item)[0]);
                populateCategoryDropdown();
            } catch (error) {
                console.error('Error fetching departments:', error);
            }
        }

        function populateCategoryDropdown() {
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = '';
            allCategories.forEach(category => {
                const div = document.createElement('div');
                div.innerText = category;
                div.className = 'cursor-pointer text-sm text-gray-800 hover:bg-gray-100 p-2';
                div.onclick = () => selectCategory(category);
                categoryList.appendChild(div);
            });
        }

        async function getSubcategories(category) {
            try {
                const response = await axios.get(`https://g1.gwcindia.in/ticket-api/ticket-category-subcategory.php?category=${category}`);
                subcategories = response.data[category] || [];
                populateSubcategoryDropdown();
            } catch (error) {
                console.error('Error fetching subcategories:', error);
            }
        }

        function populateSubcategoryDropdown() {
            const subcategoryList = document.getElementById('subcategoryList');
            subcategoryList.innerHTML = '';
            subcategories.forEach(sub => {
                const div = document.createElement('div');
                div.innerText = sub;
                div.className = 'cursor-pointer text-sm text-gray-800 hover:bg-gray-100 p-2';
                div.onclick = () => selectSubCategory(sub);
                subcategoryList.appendChild(div);
            });
        }

        function uploadImage(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFileName = file.name;
                const reader = new FileReader();
                reader.onload = () => {
                    attachment = reader.result.split(',')[1]; // Get the base64 string
                };
                reader.readAsDataURL(file);
            }
        }

        async function createTicket() {
            const subject = document.getElementById('subjectInput').value;
            const description = document.getElementById('descriptionInput').value;

            if (!selectedCategory || !selectedSubCategory || !subject || !description) {
                alert('Please fill in all fields.');
                return;
            }

            const formData = new FormData();
            formData.append('department', selectedCategory);
            formData.append('subject', subject);
            formData.append('text', description);
            formData.append('subCat', selectedSubCategory);
            if (attachment) {
                formData.append('attachment', attachment);
                formData.append('filename', selectedFileName);
            }

            try {
                const response = await axios.post('https://g1.gwcindia.in/ticket-api/create-ticket.php', formData);
                showResponseModal(response.data);
            } catch (error) {
             
                console.error('Error creating ticket:', error);
                showResponseModal({ status: 'error', message: 'Failed to create ticket.' });
            }
        }

        function showResponseModal(data) {
            const responseModal = document.getElementById('responseModal');
            const responseContent = document.getElementById('responseContent');
            responseContent.innerHTML = '';

            if (data.status === 'ok') {
                responseContent.innerHTML = `<div class="text-green-500">Ticket created successfully! Ticket No: #${data.data.ticket_no}</div>`;
            } else {
                responseContent.innerHTML = `<div class="text-red-500">${data.message}</div>`;
            }

            responseModal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('app').classList.add('hidden');
        }

        function closeResponseModal() {
            document.getElementById('responseModal').classList.add('hidden');
        }
    </script>
</body>
</html>