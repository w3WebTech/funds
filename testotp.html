<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web OTP Example</title>
</head>
<body>

  <h2>Web OTP Demo</h2>

  <!-- OTP form -->
  <form action="/verify-otp" method="POST">
    <label for="otp">Enter OTP:</label>
    <input type="text"
           id="otp"
           name="otp"
           inputmode="numeric"
           autocomplete="one-time-code"
           maxlength="6"
           required
           aria-labelledby="otp">
    <button type="submit">Submit</button>
  </form>

  <!-- Display OTP in a div -->
  <div id="otpDisplay">OTP will be displayed here.</div>

  <script>
    if ('OTPCredential' in window) {
      alert("Web OTP API is available!");

      window.addEventListener('DOMContentLoaded', () => {
        const input = document.querySelector('input[autocomplete="one-time-code"]');
        const otpDisplay = document.querySelector('#otpDisplay');

        input.focus();

        const retryCount = 3;
        const retryDelay = 500;
        let currentRetry = 0;

        const retrieveOtp = () => {
          navigator.credentials.get({
            otp: { transport: ['sms'] }
          })
            .then(otp => {
                // Debugging alert for OTP object
                alert("OTP object received: " + JSON.stringify(otp)); // Show the OTP object in JSON format
                alert("OTP code: " + otp.code); // Show the OTP value from the object

                if (otp && otp.code) {
                  input.value = otp.code;
                  otpDisplay.textContent = `Received OTP: ${otp.code}`;
                  console.log('OTP received:', otp.code);

                  // Submit form only if input has a value
                  if (input.value) {
                    input.closest('form').submit();
                  }
                } else {
                  console.error('Invalid OTP format. Please try again.');
                  alert('Invalid OTP format. Please try again.');
                }
            })
            .catch(err => {
              if (err.name === 'NotAllowedError') {
                alert('Please allow browser access to OTP messages in your browser settings.');
              } else if (err.name === 'NotFoundError') {
                alert('No OTP message found. Please try again or enter the OTP manually.');
              } else {
                console.error('Error retrieving OTP:', err);

                if (currentRetry < retryCount) {
                  currentRetry++;
                  setTimeout(retrieveOtp, retryDelay);
                } else {
                  alert('An error occurred while retrieving the OTP. Please try again later.');
                }
              }
            });
        };

        retrieveOtp();
      });
    } else {
      alert('Web OTP API is not supported in this browser.');
    }
  </script>

</body>
</html>
