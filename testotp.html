<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web OTP Example</title>
</head>
<body>

  <h2>Web OTP Demo</h2>

  <!-- OTP form -->
  <form action="/verify-otp" method="POST">
    <label for="otp">Enter OTP:</label>
    <input type="text"
           id="otp"
           name="otp"
           inputmode="numeric"
           autocomplete="one-time-code"
           maxlength="6"
           required
           aria-labelledby="otp">
    <button type="submit">Submit</button>
  </form>

  <!-- Display OTP in a div -->
  <div id="otpDisplay">OTP will be displayed here.</div>

  <script>
    if ('OTPCredential' in window) {
        alert("Web OTP API is available!");
      window.addEventListener('DOMContentLoaded', e => {
        const input = document.querySelector('input[autocomplete="one-time-code"]');
        const otpDisplay = document.querySelector('#otpDisplay');
        if (!input || !otpDisplay) return;

        // Cancel the Web OTP API if the form is submitted manually.
        const ac = new AbortController();
        const form = input.closest('form');
        if (form) {
          form.addEventListener('submit', e => {
            // Cancel the Web OTP API.
            ac.abort();
          });
        }

        // Invoke the Web OTP API
        navigator.credentials.get({
          otp: { transport: ['sms'] },
          signal: ac.signal
        }).then(otp => {
          input.value = otp.code; // Automatically fill the OTP field
          otpDisplay.textContent = `Received OTP: ${otp.code}`; // Display OTP in div
          console.log('OTP received:', otp.code);
          setTimeout(() => {
            if (form) form.submit(); // Submit after OTP is filled
          }, 1000);  // 1-second delay to ensure OTP is filled before submitting
        }).catch(err => {
            console.error('Error retrieving OTP:', err);
            alert('Error retrieving OTP: ' + err.message); // Log and alert any errors
        });
      });
    } else {
      alert('Web OTP API is not supported in this browser.');
    }
  </script>

</body>
</html>
